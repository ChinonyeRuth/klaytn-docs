# H/A Setup <a id="h-a-setup"></a>

高可用性を実現するためにCNを設定することは、コアセルを効果的に操作するために重要です。 推奨される高可用性スキームは、コアセルが物理インフラストラクチャまたはクラウドインフラストラクチャに展開されるかによって異なります。

## アクティブスタンバイ\（ベアメタルに推奨） <a id="active-standby-recommended-for-bare-metal"></a>

この設定では、アクティブスタンバイ設定に2つのCNノードがインストールされます。 通常の動作中、アクティブノードはブロック生成に参加し、スタンバイはネットワークからのチェーンデータのみを同期します。 この構成により、スタンバイCNノードは、アクティブノードで障害が発生した場合にチェーンデータの新しいコピーを持つことが保証されます。

### セットアップ <a id="setup"></a>

1. アクティブな CNの `nodekey` のバックアップを作成します。
2. スタンバイCNをインストールします。 設定はアクティブなCNの例外と同じです:
   * スタンバイは異なる `nodekey`を使用する必要があります
   * プッシュ通知のアドレスを `$DATA_DIR/static-nodes.json に追加します`

### フェイルオーバー <a id="failover"></a>

1. スタンバイCNを停止: `sudo systemctl stop kcnd`
2. スタンバイの `nodekey` を failed active CNの `nodekey` に置き換えます。
3. アクティブなCNのIPアドレスをスタンバイCNに再割り当てます。
4. スタンバイCNを起動し、ネットワークと同期していることを確認します: `sudo systemctl start kcnd`

## マシンイメージ & スナップショット \(クラウドに推奨) <a id="machine-image-snapshot-recommended-for-cloud"></a>

クラウド・インフラストラクチャにより、オペレータは失敗したノードをより迅速に置き換えることができますので、第二のスタンバイCNを操作する必要はありません。 代わりに、新しいCNがすぐにプロビジョニングされ、チェーンデータの更新されたコピーが提供されるようにするだけで十分です。

正確な用語と手順は、異なるクラウド環境で異なる場合があります。 以下の手順はAWS \(具体的にはEC2とEBS\)に基づいていますが、他のクラウドプラットフォームに適応することができます。

### セットアップ <a id="setup"></a>

1. アクティブな CNの `nodekey` のバックアップを作成します。
2. CN構成またはソフトウェアが更新されるたびに、マシンイメージ\(例:AMI\)を作成します。 この画像には `DATA_DIR` を含むボリュームを含まないでください。

### フェイルオーバー <a id="failover"></a>

チェーンデータのスナップショットを取得するには、CCのPNノードのいずれかを使用します。

1. PNノードに接続し、kpndを停止: `sudo systemctl stop kpnd`. データの一貫性を確保するために、最初に kpnd を停止することが重要です。
2. AWSコンソールを使用して、PNの `DATA_DIR`を含むボリュームのスナップショットを作成します。
3. Start kpnd: `sudo systemctl start kpnd`

ベースCNイメージとチェーンデータイメージを使用して新しいCNを作成します。

1. CNイメージ\(上記の「セットアップ」で作成した)を使用してインスタンスを作成します。
2. プッシュ通知の `$DATA_DIR` のスナップショットから作成されたボリュームを添付します。
3. `$DATA_DIR/klay/chaindata` を除くすべてのファイルをボリュームから削除します。 `kcnd.conf` に設定された `DATA_DIR` が、チェーンデータを含むディレクトリと一致することを確認します。 名前が違う場合は、ディレクトリ名を変更する必要があるかもしれません。
4. 失敗した CN の `nodekey` を `$DATA_DIR/klay/nodekey` にコピーします。
5. 失敗したCNのIPアドレスを置き換えに再割り当てます。
6. Start kcnd: `sudo systemctl start kcnd`
7. CNがネットワークと同期していることを確認します。

## 追加の考慮事項 <a id="additional-considerations"></a>

失敗したCNのパブリックIPを置換CNに再割り当てると、交換はすぐに他のCNに接続することができます。 IPが変更された場合、他のすべてのCCOがファイアウォール設定を更新するまで、新しいCNはネットワークに接続できません。


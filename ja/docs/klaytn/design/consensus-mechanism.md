# コンセンサスメカニズム <a id="consensus-mechanism"></a>

コンセンサスメカニズム(アルゴリズム)は、信頼できない主体間のコンセンサスに達する方法です。 ブロックチェーン技術では、ブロックが有効かどうかについて合意に達するために使用されます。 ブロックチェーンネットワークのパフォーマンスは、採用されたコンセンサスメカニズムのパフォーマンスに依存しています。 そして、それはBlockchainアプリケーションの知覚された使いやすさに大きな影響を与えます。

Klaytn Mainnet サイプレスは以下のようなパフォーマンスを発揮します。
- 毎秒4,000トランザクションを処理します。
- 即時トランザクションの終了。
- 1秒のブロック生成時間。
- 50以上のコンセンサスノードがコンセンサスプロセスに参加できます。

このドキュメントでは、Klaytnがどのように高性能のコンセンサスプロセスを実装したかについて説明します。

## 背景 <a id="background"></a>

[Bitcoin](https://en.wikipedia.org/wiki/Bitcoin) is using [PoW](https://en.wikipedia.org/wiki/Proof_of_work) (Proof-of-Work), whereas Ethereum has recently shifted to [PoS](https://en.wikipedia.org/wiki/Proof_of_stake) (Proof-of-Stake), which decides on the block generating nodes by the stake of the node. 通常、これらのアルゴリズムは、ブロックの妥当性を決定する際にノード間の通信を伴いません。

これらのシステムでは、フォークが発生する可能性があります。つまり、2つ以上の異なるブロックを同じ高さで作ることができます。 通常、フォーク状態を解決するために「ロングチェーンが勝つ」ルールが適用されます。 それらのフォークは最終的には単一の正規チェーンにマージされることを意味します ブロックのリストは短い鎖に属する時間内に元に戻すこともできます したがって、これらのアルゴリズムには、ブロックとトランザクションの最終性を保証するものはありません。 最終性のみ確率的に達成することができます期間の後、それはまだ100%保証することはできません。

このような最終性の欠如は、ブロックチェーンプラットフォームを使用する顧客向けサービスにおいて非常に困難な問題です。 フォークが解決され、転送後に十分なブロックが積み上げられるまで待たなければならないため、トランザクションは取り消せないと信じられます。 これは、ユーザーとサービスプロバイダーの両方に悪影響を及ぼします。

この問題の簡単な例は、金融サービスで示すことができます。 ユーザーが誰かに送金した場合、30分から60分が経過するまで、サービスは送金が有効であることを確認できません。 フォークが1つのチェーンにマージされ、転送後に複数のブロックが積み上げられるまで待つ必要があるため、トランザクションが取り消せないことを確認する必要があります。

### PBFT(実用的なビザンチンフォールトトレランス)  <a id="pbft-practical-byzantine-fault-tolerance"></a>
上記の問題を防ぐためには、最終性を保証する他のアルゴリズムが必要です。 BFT algorithm is one of those, first [published](https://dl.acm.org/citation.cfm?doid=357172.357176) in 1982 by Lamport, Shostak, Pease. 1999年、ミゲル・カストロとバーバラ・リスコフは、高性能な状態機械の複製を提供する「実用的なビザンチン故障耐性」([PBFT](http://www.pmg.csail.mit.edu/papers/bft-tocs.pdf))を発表した。

上記のPoWアルゴリズムでは、各ノードはブロックを受信して検証しますが、ノード間でコンセンサスに到達するためのメッセージ交換はありません。 しかしPBFTでは 各ノードは他の参加ノードと通信してコンセンサスに達し、ノードがコンセンサスに達するとすぐにブロックの最終性が保証されます。

ノード間の通信は以下のように基本的に進みます。 しかし、それぞれのシステムの特性を反映したいくつかのバリエーションがあります。

![PBFT のメッセージフロー](../images/pbft.png)

上に示したように、PBFTに参加するノードは、基本的にいくつかのフェーズでネットワーク内のすべてのノードと通信します。 ノード数が増えるにつれて通信量が指数関数的に増加するため、ノード数が制限されます。

## Klaytnのコンセンサスメカニズム <a id="consensus-mechanism-in-klaytn"></a>
Klaytnは、エンタープライズ対応でサービス中心のプラットフォームを目指しています。 したがって、上記に書かれた最終的な問題を解決する必要があり、ネットワークは多くのノードがネットワークに参加できるようにする必要があります。 これを可能にするために、Klaytnは最適化されたイスタンブールBFTを使用しています。これはブロックチェーンネットワークの特性を扱うためにPBFTを変更して実装しています。

Klaytnには、CN(コンセンサスノード)、PN(プロキシノード)、EN(エンドポイントノード)の3種類のノードがあります。 CNsはCCO(コアセル演算子)によって管理され、ブロック生成を担当しています。 これらのブロックは、ネットワーク内のすべてのノードによって検証されます。 このネットワークトポロジの詳細については、 [](../README.md#klaytn-network-topology) を参照してください。

![ネットワーク・トポジー](../images/klaytn_network_node.png)

KlaytnはイスタンブールBFTの採用と改善により、高速な最終性を実現します。 検証とコンセンサスは各ブロックごとに行われるため、フォークはなく、コンセンサスが作成されるとすぐにブロックの最終性が即座に保証されます。

また、ランダムに選択された `委員会`を利用することで、BFTアルゴリズムにおける通信量の増加の問題を解決しました。 CNs collectively form a `Council` and on each block generation, part of them are selected as a member of `Committee` using a VRF (Verifiable Random Function).

![協議会・委員会のコンセプト](../images/council-committee.png)

コンセンサスメッセージは、委員会メンバー間でのみ交換されるので。 CNの総数が増えても、設計されたレベルで通信量を制限することができます。

現在、Klaytn Mainnet Cypressは1秒間ブロック生成間隔で毎秒4,000トランザクションの高いスループットを提供できます。 現時点では50以上のコンセンサスノードがCNN(コンセンサスノードネットワーク)に参加することができ、Klaytnがアルゴリズムを積極的に最適化し続けるにつれて、その数は継続的に増加します。

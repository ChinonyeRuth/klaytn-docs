# マルチチャンネル <a id="multi-channel"></a>

Klaytn ノードは **マルチチャンネル** で実行できます。

マルチチャンネル構成でノードが実行される場合、通信のためのポートは 2 つに設定されます。 一方、単一のチャンネル構成でノードが実行されると、1 ポートが設定されます。 2 つのマルチチャネルノードが接続しようとしている場合、2 つのポートを使用して接続が確立されます。 そうでなければ、彼らは通信のために1ポートを使用します。

フラグ `--multichannel` を介してマルチチャンネルノードを有効にすることができます。 If you use [`kend`](../../node/endpoint-node/operation-guide/starting-stopping-en.md), multi-channel is enabled by default due to the statement `MULTICHANNEL=1` in [`kend.conf`](../../node/endpoint-node/operation-guide/configuration.md). マルチチャネルを無効にするには、ステートメントを `MULTICHANNEL=0` に置き換えてください。 特定のポートを持つノードを実行したい場合は、フラグ `ポート` と `サブポート` を使用できます。 接続ピアのポート値を指定したい場合は、 [KNI](./kni.md) をチェックしてください。

## 建築 <a id="architecture"></a>

![マルチチャンネルサーバー](../images/multichannel.png)

上の図は、2 つのマルチチャンネルノード間の接続を示しています。 2つのポート、メインポート(A)、サブポート(B)、異なるメッセージを転送します。
* **Mainport**(A) は、ブロックとコンセンサスプロトコルに関連するメッセージを転送するために使われる。
  * ブロックメッセージには、ハッシュ、ヘッダー、ボディ、およびブロックの受領のリクエストと応答が含まれます。
  * コンセンサスメッセージには、Request、Preprepare、Prepare、Commit、RoundChangeが含まれます。 メッセージの意味は [PBFT](./consensus-mechanism.md#pbft-practical-byzantine-fault-tolerance) にあります。
* **サブポート**(B) はトランザクションメッセージを転送するためのものです。

![シングルチャンネルサーバー](../images/singlechannel.png)

画像は、2 つの単一のチャネルノード間、または単一のチャネルノードとマルチチャネルノード間の接続を示しています。 この場合、ブロック、トランザクション、およびコンセンサスプロトコルに関連するすべてのメッセージは、同じポートを介して転送されます。

## ポート  <a id="multichannel-port"></a>

KNIでポート番号を設定するには、 [KNIスキーム](./kni.md) を参照してください。
* シングルチャンネル : シングルチャンネルノードは1つのポートを使用します(デフォルトは32323)。
* マルチチャンネル: マルチチャンネルノードは 2 つのポートを使用します。 ポートは `ポート` と `サブポート` で指定できます。 Klaytn では、 `ポート` と `サブポート` のデフォルト値はそれぞれ 32323 と 32324 です。
    * マルチチャンネルノードに接続する際に `サブポート` を設定できない場合があります。 この場合、最初は Klaytn ノードはシングルチャネルを使用して接続しようとします。 ハンドシェイクプロセスでは、実際のピアのポート番号が明らかになります。 ピアがマルチチャネルノードの場合、継続中の接続はキャンセルされ、更新されたポートで再接続が行われます。
